<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stock</title>
    <link rel="manifest" href="./manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --bg-light: #f8f9fa;
            --text-dark: #212529;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            overflow-x: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        #sidebar.active {
            margin-left: calc(var(--sidebar-width) * -1);
        }

        .sidebar-header {
            padding: 20px;
            background: var(--primary-color);
            color: white;
        }

        .sidebar-menu {
            padding: 20px 0;
            list-style: none;
            flex-grow: 1;
        }

        .sidebar-menu li a {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            color: var(--text-dark);
            text-decoration: none;
            transition: 0.2s;
            border-left: 4px solid transparent;
        }

        .sidebar-menu li a:hover, .sidebar-menu li a.active {
            background-color: #e9ecef;
            border-left-color: var(--primary-color);
            color: var(--primary-color);
        }

        .sidebar-menu li a i {
            margin-right: 10px;
        }

        /* Main Content */
        #content {
            width: calc(100% - var(--sidebar-width));
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: all 0.3s;
        }

        #content.active {
            width: 100%;
            margin-left: 0;
        }

        /* Navbar */
        .top-navbar {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #sidebar {
                margin-left: calc(var(--sidebar-width) * -1);
            }
            #sidebar.active {
                margin-left: 0;
            }
            #content {
                width: 100%;
                margin-left: 0;
            }
            #content.active {
                margin-left: var(--sidebar-width); 
                /* Note: On mobile, active sidebar pushes content or overlays. 
                   Let's make it overlay for better mobile exp */
            }
        }
        
        /* Loading Skeleton Animation */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Utility */
        .view-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        .view-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card-icon {
            font-size: 2rem;
            opacity: 0.8;
        }
        
        .cursor-pointer {
            cursor: pointer;
        }

        /* Dark Mode */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        body.dark-mode #sidebar {
            background-color: #1e1e1e;
        }
        body.dark-mode .sidebar-menu li a {
            color: #e0e0e0;
        }
        body.dark-mode .sidebar-menu li a:hover, body.dark-mode .sidebar-menu li a.active {
            background-color: #2c2c2c;
        }
        body.dark-mode .top-navbar {
            background-color: #1e1e1e;
        }
        body.dark-mode .card {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        body.dark-mode .card-header, body.dark-mode .card-footer {
            background-color: #2c2c2c;
            color: #e0e0e0;
        }
        body.dark-mode .table {
            color: #e0e0e0;
            --bs-table-color: #e0e0e0;
        }
        body.dark-mode .table-light {
            --bs-table-bg: #2c2c2c;
            --bs-table-color: #e0e0e0;
        }
        body.dark-mode .form-control, body.dark-mode .form-select {
            background-color: #2c2c2c;
            border-color: #444;
            color: #e0e0e0;
        }
        body.dark-mode .dropdown-menu {
            background-color: #1e1e1e;
            border-color: #444;
        }
        body.dark-mode .dropdown-item {
            color: #e0e0e0;
        }
        body.dark-mode .dropdown-item:hover {
            background-color: #2c2c2c;
        }
        body.dark-mode .list-group-item {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border-color: #444;
        }

        /* Login Overlay */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f8f9fa;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }
        body.dark-mode #login-overlay {
            background-color: #121212;
        }
        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            background: white;
        }
        body.dark-mode .login-card {
            background: #1e1e1e;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        /* Offline Banner */
        #offlineBanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #dc3545;
            color: white;
            text-align: center;
            padding: 5px;
            z-index: 2100;
            display: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Bottom Navbar */
        .bottom-navbar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1050;
            justify-content: space-around;
            padding: 10px 0;
        }
        .bottom-navbar .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            color: #6c757d;
            text-decoration: none;
        }
        .bottom-navbar .nav-link i {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
        }
        .bottom-navbar .nav-link.active {
            color: var(--primary-color);
        }
        body.dark-mode .bottom-navbar {
            background-color: #1e1e1e;
        }
        body.dark-mode .bottom-navbar .nav-link {
            color: #b0b0b0;
        }
        body.dark-mode .bottom-navbar .nav-link.active {
            color: #0d6efd;
        }

        /* Responsive Mobile adjustments */
        @media (max-width: 768px) {
            #sidebar {
                display: none !important; /* Hide sidebar completely */
            }
            #sidebarCollapse {
                display: none; /* Hide toggle button */
            }
            #content {
                width: 100%;
                margin-left: 0;
                padding-bottom: 80px; /* Space for bottom nav */
            }
            .bottom-navbar {
                display: flex; /* Show bottom nav */
            }
            
            /* Card View for Products Table */
            #products table thead { display: none; }
            #products table tbody tr {
                display: flex;
                flex-wrap: wrap;
                margin-bottom: 1rem;
                border: 1px solid #dee2e6;
                border-radius: 0.5rem;
                padding: 0.5rem;
                background-color: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            body.dark-mode #products table tbody tr {
                background-color: #1e1e1e;
                border-color: #444;
            }
            #products table tbody td {
                border: none;
                padding: 0.25rem 0.5rem;
            }
            
            /* Specific Cell Styling */
            #products table tbody td:nth-child(1) { width: 60px; } /* Image */
            #products table tbody td:nth-child(2) { width: calc(100% - 60px); font-size: 0.85rem; color: #6c757d; order: 1; padding-bottom: 0; } /* Code */
            #products table tbody td:nth-child(3) { width: calc(100% - 60px); font-weight: bold; font-size: 1.1rem; order: 2; padding-top: 0; } /* Name */
            
            /* Move Image to float left of Code/Name */
            #products table tbody td:nth-child(1) { order: 0; display: flex; align-items: center; justify-content: center; }

            #products table tbody td:nth-child(4) { display: none; } /* Hide Category */
            
            #products table tbody td:nth-child(5) { width: 50%; order: 3; font-size: 0.9rem; color: #6c757d; } /* Variant */
            #products table tbody td:nth-child(6) { width: 50%; order: 4; text-align: right; } /* Stock */
            
            #products table tbody td:nth-child(7) { width: 100%; order: 5; margin-top: 0.5rem; border-top: 1px dashed #dee2e6; padding-top: 0.5rem; text-align: right; } /* Action */
        }
    </style>
</head>
<body>

    <div id="offlineBanner">
        <i data-feather="wifi-off" style="width: 16px; height: 16px; vertical-align: text-bottom;"></i> Mode Offline: Anda hanya dapat melihat data.
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-card text-center">
            <div class="mb-4">
                <i data-feather="box" class="text-primary" style="width: 64px; height: 64px;"></i>
                <h3 class="mt-2 fw-bold">Smart Stock</h3>
                <p class="text-muted">Silahkan login untuk melanjutkan</p>
            </div>
            <form id="loginForm">
                <div class="mb-3 text-start">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" name="username" placeholder="admin" required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" name="password" placeholder="admin" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2">Masuk</button>
                <div id="loginError" class="text-danger mt-3 small"></div>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header d-flex align-items-center">
            <i data-feather="box" class="me-2"></i>
            <h4 class="m-0">Smart Stock</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="nav-link active" data-target="dashboard"><i data-feather="home"></i> Dashboard</a></li>
            <li><a href="#" class="nav-link" data-target="products"><i data-feather="package"></i> Data Barang</a></li>
            <li><a href="#" class="nav-link" data-target="transactions"><i data-feather="refresh-cw"></i> Transaksi Stok</a></li>
            <li class="nav-item-role role-request" style="display:none;"><a href="#" class="nav-link" data-target="requests"><i data-feather="truck"></i> Request Stok</a></li>
            <li class="nav-item-role role-master" style="display:none;"><a href="#" class="nav-link" data-target="master"><i data-feather="database"></i> Master Data</a></li>
            <li class="nav-item-role role-audit" style="display:none;"><a href="#" class="nav-link" data-target="audit"><i data-feather="file-text"></i> Audit Log</a></li>
            <li><a href="#" class="nav-link" data-target="opname"><i data-feather="clipboard"></i> Stok Opname</a></li>
            <li><a href="#" class="nav-link" data-target="reports"><i data-feather="bar-chart-2"></i> Laporan</a></li>
            <li><a href="#" class="nav-link" data-target="settings"><i data-feather="settings"></i> Pengaturan</a></li>
        </ul>
        <div class="p-3 text-muted" style="font-size: 0.8rem; border-top: 1px solid rgba(0,0,0,0.1);">
            <i data-feather="hard-drive" style="width: 14px; height: 14px;"></i> Penyimpanan: Lokal
        </div>
    </nav>

    <!-- Main Content -->
    <div id="content">
        <!-- Top Navbar -->
        <nav class="top-navbar">
            <button type="button" id="sidebarCollapse" class="btn btn-light text-primary">
                <i data-feather="menu"></i>
            </button>
            
            <div class="d-flex align-items-center">
                <button class="btn btn-link text-secondary me-3" id="darkModeToggle" title="Toggle Dark Mode">
                    <i data-feather="moon"></i>
                </button>
                <div class="dropdown me-3">
                    <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" id="locationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i data-feather="map-pin" class="me-1"></i> <span id="currentLocationLabel">Semua Lokasi</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="locationSelectMenu">
                        <!-- Populated by JS -->
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link text-dark text-decoration-none dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i data-feather="user"></i> <span id="userNameDisplay">Admin</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="#" onclick="openProfileModal()">Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="doLogout()">Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Views Container -->
        <div id="main-container">
            
            <!-- DASHBOARD VIEW -->
            <div id="dashboard" class="view-section active">
                <h3 class="mb-4">Dashboard</h3>
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="card text-white bg-primary h-100">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">Total Barang</h6>
                                    <h2 class="mb-0" id="dash-total-items">0</h2>
                                </div>
                                <i data-feather="package" class="card-icon text-white-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card text-white bg-success h-100">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">Stok Total</h6>
                                    <h2 class="mb-0" id="dash-total-qty">0</h2>
                                </div>
                                <i data-feather="layers" class="card-icon text-white-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card text-white bg-warning h-100">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">Perlu Re-order</h6>
                                    <h2 class="mb-0" id="dash-low-stock">0</h2>
                                </div>
                                <i data-feather="alert-circle" class="card-icon text-white-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card text-white bg-info h-100">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">Transaksi Hari Ini</h6>
                                    <h2 class="mb-0" id="dash-today-tx">0</h2>
                                </div>
                                <i data-feather="activity" class="card-icon text-white-50"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-lg-8">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="card-title mb-0">Pergerakan Stok (7 Hari Terakhir)</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="stockChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="card-title mb-0">Aktivitas Terbaru</h5>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush" id="recent-activity-list">
                                    <!-- Populated by JS -->
                                    <li class="list-group-item text-center text-muted py-4">Belum ada aktivitas</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRODUCT VIEW -->
            <div id="products" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Data Barang</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i data-feather="plus"></i> Tambah Barang
                    </button>
                </div>
                
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="productSearch" placeholder="Cari nama, kode, atau kategori...">
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Gambar</th>
                                        <th>Kode</th>
                                        <th>Nama Barang</th>
                                        <th>Kategori</th>
                                        <th>Varian</th>
                                        <th>Total Stok</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="productTableBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRANSACTIONS VIEW -->
            <div id="transactions" class="view-section">
                <h3 class="mb-4">Transaksi Stok</h3>
                
                <ul class="nav nav-tabs mb-4" id="transTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-in">Barang Masuk</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-out">Barang Keluar</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-transfer">Transfer Antar Lokasi</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-incoming">Barang Masuk (Transfer)</button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- INCOMING TRANSFER -->
                    <div class="tab-pane fade" id="tab-incoming">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead><tr><th>Tanggal</th><th>Dari</th><th>Barang</th><th>Qty</th><th>Status</th><th>Aksi</th></tr></thead>
                                        <tbody id="incomingTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- IN -->
                    <div class="tab-pane fade show active" id="tab-in">
                        <div class="card shadow-sm mw-800">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Input Barang Masuk</h5>
                                <form id="formStockIn">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Lokasi Tujuan</label>
                                            <select class="form-select select-location" required name="location">
                                                <!-- Populated JS -->
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Tanggal</label>
                                            <input type="date" class="form-control" required name="date">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Cari Barang (Scan/Ketik)</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control product-search-input" placeholder="Kode atau Nama Barang" autocomplete="off">
                                                <button class="btn btn-outline-secondary" type="button"><i data-feather="search"></i></button>
                                                <button class="btn btn-outline-secondary" type="button" onclick="startScanner(this)"><i data-feather="camera"></i></button>
                                            </div>
                                            <input type="hidden" name="product_id">
                                            <div class="product-search-results list-group position-absolute w-100" style="z-index: 1000; display:none;"></div>
                                            <div class="selected-product-info mt-2 text-primary fw-bold"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Jumlah Masuk</label>
                                            <input type="number" class="form-control" min="1" required name="qty">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Keterangan / Supplier</label>
                                            <input type="text" class="form-control" name="notes">
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="submit" class="btn btn-danger"><i data-feather="save"></i> Simpan Masuk</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- OUT -->
                    <div class="tab-pane fade" id="tab-out">
                         <div class="card shadow-sm mw-800">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Input Barang Keluar (Penjualan/Rusak)</h5>
                                <form id="formStockOut">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Lokasi Asal</label>
                                            <select class="form-select select-location" required name="location">
                                                <!-- Populated JS -->
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Tanggal</label>
                                            <input type="date" class="form-control" required name="date">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Cari Barang</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control product-search-input" placeholder="Kode atau Nama Barang" autocomplete="off">
                                                <button class="btn btn-outline-secondary" type="button"><i data-feather="search"></i></button>
                                                <button class="btn btn-outline-secondary" type="button" onclick="startScanner(this)"><i data-feather="camera"></i></button>
                                            </div>
                                            <input type="hidden" name="product_id">
                                            <div class="product-search-results list-group position-absolute w-100" style="z-index: 1000; display:none;"></div>
                                            <div class="selected-product-info mt-2 text-primary fw-bold"></div>
                                            <div class="current-stock-display text-muted small"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Jumlah Keluar</label>
                                            <input type="number" class="form-control" min="1" required name="qty">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Alasan</label>
                                            <select class="form-select" name="reason">
                                                <option value="sales">Penjualan</option>
                                                <option value="damaged">Rusak/Hilang</option>
                                                <option value="other">Lainnya</option>
                                            </select>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="submit" class="btn btn-primary"><i data-feather="save"></i> Simpan Keluar</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- TRANSFER -->
                    <div class="tab-pane fade" id="tab-transfer">
                         <div class="card shadow-sm mw-800">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Transfer Antar Lokasi</h5>
                                <form id="formStockTransfer">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Dari Lokasi</label>
                                            <select class="form-select select-location" required name="from_location">
                                                <!-- Populated JS -->
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Ke Lokasi</label>
                                            <select class="form-select select-location" required name="to_location">
                                                <!-- Populated JS -->
                                            </select>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Tanggal</label>
                                            <input type="date" class="form-control" required name="date">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Cari Barang</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control product-search-input" placeholder="Kode atau Nama Barang" autocomplete="off">
                                                <button class="btn btn-outline-secondary" type="button"><i data-feather="search"></i></button>
                                                <button class="btn btn-outline-secondary" type="button" onclick="startScanner(this)"><i data-feather="camera"></i></button>
                                            </div>
                                            <input type="hidden" name="product_id">
                                            <div class="product-search-results list-group position-absolute w-100" style="z-index: 1000; display:none;"></div>
                                            <div class="selected-product-info mt-2 text-primary fw-bold"></div>
                                            <div class="current-stock-display text-muted small"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Jumlah Transfer</label>
                                            <input type="number" class="form-control" min="1" required name="qty">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Keterangan</label>
                                            <input type="text" class="form-control" name="notes">
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="submit" class="btn btn-info text-white"><i data-feather="save"></i> Proses Transfer</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STOCK OPNAME VIEW -->
            <div id="opname" class="view-section">
                <h3 class="mb-4">Stok Opname</h3>
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <form id="formOpname">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Lokasi</label>
                                    <select class="form-select select-location" id="opnameLocation">
                                        <!-- JS -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tanggal Opname</label>
                                    <input type="date" class="form-control" id="opnameDate">
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-primary w-100" onclick="loadOpnameForm()">Mulai Opname</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="opnameWorkArea" style="display:none;">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Form Input Fisik</h5>
                            <span class="badge bg-warning text-dark" id="opnameTargetLabel">Lokasi: -</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Barang</th>
                                            <th>Stok Sistem</th>
                                            <th width="150">Stok Fisik</th>
                                            <th>Selisih</th>
                                            <th>Catatan</th>
                                        </tr>
                                    </thead>
                                    <tbody id="opnameTableBody">
                                        <!-- Rows generated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-white text-end">
                            <button class="btn btn-success" onclick="saveOpname()"><i data-feather="save"></i> Simpan Hasil Opname</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REPORTS VIEW -->
            <div id="reports" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Laporan</h3>
                    <button class="btn btn-success" onclick="exportReportToExcel()">
                        <i data-feather="download"></i> Export Excel
                    </button>
                </div>
                
                <div class="card shadow-sm">
                     <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" onclick="switchReport('stock')">Laporan Stok</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="switchReport('mutations')">Mutasi Barang</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <select class="form-select select-location" id="reportLocationFilter" onchange="refreshReport()">
                                    <option value="">Semua Lokasi</option>
                                    <!-- JS -->
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="reportTable">
                                <thead class="table-light" id="reportTableHead">
                                    <!-- Dynamic headers -->
                                </thead>
                                <tbody id="reportTableBody">
                                    <!-- Dynamic Body -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MASTER DATA VIEW -->
            <div id="master" class="view-section">
                <h3>Master Data</h3>
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs" id="masterTabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#master-cat">Kategori</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#master-color">Warna</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#master-size">Ukuran</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <!-- Category -->
                            <div class="tab-pane fade show active" id="master-cat">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="newCatInput" placeholder="Nama Kategori Baru">
                                    <button class="btn btn-success" onclick="addMaster('categories')"><i data-feather="plus"></i> Tambah</button>
                                </div>
                                <ul class="list-group" id="list-categories">
                                    <!-- JS -->
                                </ul>
                            </div>
                            <!-- Color -->
                            <div class="tab-pane fade" id="master-color">
                                 <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="newColorInput" placeholder="Warna Baru">
                                    <button class="btn btn-success" onclick="addMaster('colors')"><i data-feather="plus"></i> Tambah</button>
                                </div>
                                <ul class="list-group" id="list-colors"></ul>
                            </div>
                            <!-- Size -->
                            <div class="tab-pane fade" id="master-size">
                                 <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="newSizeInput" placeholder="Ukuran Baru">
                                    <button class="btn btn-success" onclick="addMaster('sizes')"><i data-feather="plus"></i> Tambah</button>
                                </div>
                                <ul class="list-group" id="list-sizes"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REQUESTS & RETURNS VIEW -->
            <div id="requests" class="view-section">
                <h3 class="mb-4">Request & Retur</h3>
                
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <ul class="nav nav-tabs card-header-tabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-req-list">Request Stok</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ret-list">Retur Barang</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <!-- Request List -->
                            <div class="tab-pane fade show active" id="tab-req-list">
                                <div class="text-end mb-3">
                                    <button class="btn btn-primary role-request" onclick="openRequestModal()"><i data-feather="plus"></i> Buat Request</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead><tr><th>Tanggal</th><th>Lokasi</th><th>Barang</th><th>Status</th><th>Aksi</th></tr></thead>
                                        <tbody id="requestTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Return List -->
                            <div class="tab-pane fade" id="tab-ret-list">
                                <div class="text-end mb-3">
                                    <button class="btn btn-warning role-request" onclick="openReturnModal()"><i data-feather="rotate-ccw"></i> Buat Retur</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead><tr><th>Tanggal</th><th>Lokasi</th><th>Barang</th><th>Status</th><th>Aksi</th></tr></thead>
                                        <tbody id="returnTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUDIT VIEW -->
            <div id="audit" class="view-section">
                <h3>Audit Log</h3>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead><tr><th>Waktu</th><th>User</th><th>Role</th><th>Aksi</th><th>Detail</th></tr></thead>
                                <tbody id="auditTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

             <!-- SETTINGS VIEW -->
            <div id="settings" class="view-section">
                <h3>Pengaturan</h3>
                
                <div class="row g-4">
                    <!-- Data Management -->
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i data-feather="database" class="me-2"></i>Backup & Restore</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Simpan data aplikasi ke file JSON atau pulihkan data dari file backup.</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="backupData()">
                                        <i data-feather="download"></i> Download Backup Data (Excel)
                                    </button>
                                    <hr>
                                    <label class="form-label">Restore Data</label>
                                    <input type="file" class="form-control" id="restoreFile" accept=".xlsx">
                                    <button class="btn btn-outline-warning" onclick="restoreData()">
                                        <i data-feather="upload"></i> Restore Data
                                    </button>
                                </div>
                                <hr>
                                <button class="btn btn-danger w-100" onclick="resetApp()">
                                    <i data-feather="trash-2"></i> Reset Aplikasi (Hapus Semua)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- User Management (Admin Only) -->
                    <div class="col-md-6" id="userManagementSection" style="display:none;">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i data-feather="users" class="me-2"></i>Manajemen User</h5>
                                <button class="btn btn-sm btn-success" onclick="openAddUserModal()">
                                    <i data-feather="plus"></i> Tambah
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 400px; overflow-y:auto;">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Username</th>
                                                <th>Nama</th>
                                                <th>Lokasi</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="userTableBody">
                                            <!-- Populated JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Bottom Navbar (Mobile) -->
    <nav class="bottom-navbar">
        <a href="#" class="nav-link active" data-target="dashboard">
            <i data-feather="home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-link" data-target="products">
            <i data-feather="package"></i>
            <span>Barang</span>
        </a>
        <a href="#" class="nav-link" data-target="transactions">
            <i data-feather="refresh-cw"></i>
            <span>Tx</span>
        </a>
        <a href="#" class="nav-link nav-item-role role-request" data-target="requests" style="display:none;">
            <i data-feather="truck"></i>
            <span>Req</span>
        </a>
        <a href="#" class="nav-link" data-target="opname">
            <i data-feather="clipboard"></i>
            <span>Opname</span>
        </a>
        <a href="#" class="nav-link" data-target="reports">
            <i data-feather="bar-chart-2"></i>
            <span>Laporan</span>
        </a>
        <a href="#" class="nav-link" data-target="settings">
            <i data-feather="settings"></i>
            <span>Set</span>
        </a>
    </nav>

    <!-- Modals -->
    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Profil Pengguna</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; font-size: 32px;">
                            <i data-feather="user"></i>
                        </div>
                    </div>
                    <h4 id="profileName">-</h4>
                    <p class="text-muted mb-1" id="profileRole">-</p>
                    <span class="badge bg-secondary" id="profileLocation">-</span>
                    <div class="mt-4">
                        <button class="btn btn-outline-danger" onclick="doLogout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Form Modal -->
    <div class="modal fade" id="userFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userFormTitle">Tambah User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" name="mode" value="add"> <!-- add/edit -->
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="text" class="form-control" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" name="role" id="userFormRole" onchange="toggleLocSelect()">
                                <option value="staff">Kepala Cabang / Staf</option>
                                <option value="admin">Admin Pusat</option>
                            </select>
                        </div>
                        <div class="mb-3" id="userFormLocDiv">
                            <label class="form-label">Lokasi Tugas</label>
                            <select class="form-select select-location" name="location">
                                <!-- JS -->
                            </select>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Return Modal -->
    <div class="modal fade" id="returnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buat Retur Barang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="returnForm">
                        <div class="mb-3">
                            <label class="form-label">Cari Barang</label>
                            <div class="input-group">
                                <input type="text" class="form-control product-search-input" placeholder="Kode/Nama">
                                <button class="btn btn-outline-secondary" type="button"><i data-feather="search"></i></button>
                                <button class="btn btn-outline-secondary" type="button" onclick="startScanner(this)"><i data-feather="camera"></i></button>
                            </div>
                            <input type="hidden" name="product_id">
                            <div class="product-search-results list-group position-absolute w-100" style="z-index: 1000; display:none;"></div>
                            <div class="selected-product-info mt-2 text-primary fw-bold"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jumlah</label>
                            <input type="number" class="form-control" name="qty" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alasan Retur</label>
                            <textarea class="form-control" name="reason" rows="2"></textarea>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-warning">Kirim Retur</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buat Request Stok</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <div class="mb-3">
                            <label class="form-label">Cari Barang</label>
                            <div class="input-group">
                                <input type="text" class="form-control product-search-input" placeholder="Kode/Nama">
                                <button class="btn btn-outline-secondary" type="button"><i data-feather="search"></i></button>
                                <button class="btn btn-outline-secondary" type="button" onclick="startScanner(this)"><i data-feather="camera"></i></button>
                            </div>
                            <input type="hidden" name="product_id">
                            <div class="product-search-results list-group position-absolute w-100" style="z-index: 1000; display:none;"></div>
                            <div class="selected-product-info mt-2 text-primary fw-bold"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jumlah</label>
                            <input type="number" class="form-control" name="qty" min="1" required>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">Kirim Request</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div class="modal fade" id="scannerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Scan Barcode</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="stopScanner()"></button>
                </div>
                <div class="modal-body">
                    <div id="reader" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Barang Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label class="form-label">Kode Barang (Barcode)</label>
                            <input type="text" class="form-control" name="code" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Barang</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Minimum Stok</label>
                            <input type="number" class="form-control" name="min_stock" value="5">
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <label class="form-label">Kategori</label>
                                <select class="form-select master-cat" name="category"></select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Warna</label>
                                <select class="form-select master-color" name="color"></select>
                            </div>
                        </div>
                         <div class="mb-3">
                            <label class="form-label">Ukuran</label>
                             <select class="form-select master-size" name="size"></select>
                        </div>
                         <div class="mb-3">
                            <label class="form-label">URL Foto (Opsional)</label>
                            <input type="url" class="form-control" name="image" placeholder="https://...">
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Barang & Stok</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="editTabs">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#edit-details">Detail Barang</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#edit-stock">Koreksi Stok</button></li>
                    </ul>

                    <form id="editProductForm">
                        <input type="hidden" name="id">
                        <div class="tab-content">
                            <!-- DETAILS -->
                            <div class="tab-pane fade show active" id="edit-details">
                                <div class="alert alert-warning d-none" id="edit-master-warning">Anda tidak memiliki akses mengubah detail barang.</div>
                                <div class="mb-3">
                                    <label class="form-label">Kode Barang</label>
                                    <input type="text" class="form-control" name="code" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nama Barang</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Minimum Stok</label>
                                    <input type="number" class="form-control" name="min_stock">
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <label class="form-label">Kategori</label>
                                        <select class="form-select master-cat" name="category"></select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Warna</label>
                                        <select class="form-select master-color" name="color"></select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ukuran</label>
                                    <select class="form-select master-size" name="size"></select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">URL Foto</label>
                                    <input type="url" class="form-control" name="image">
                                </div>
                            </div>
                            
                            <!-- STOCK -->
                            <div class="tab-pane fade" id="edit-stock">
                                <div class="alert alert-info">Masukkan jumlah stok real saat ini. Sistem akan otomatis menghitung selisih.</div>
                                <div id="edit-stock-inputs">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-end">
                            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        // --- 1. INITIALIZATION & DATA STORE ---
        
        // Default Data
        const LOCATIONS = ['Gudang', 'Toko Cabang 1', 'Toko Cabang 2', 'Toko Cabang 3'];
        
        const DEFAULT_MASTER = {
            categories: ['Atasan', 'Bawahan', 'Outer', 'Aksesoris'],
            colors: ['Hitam', 'Putih', 'Merah', 'Biru', 'Kuning'],
            sizes: ['S', 'M', 'L', 'XL', 'ALL SIZE']
        };

        // Default Users (Seed)
        const DEFAULT_USERS = {
            'admin': { pass: 'admin', name: 'Admin Pusat', role: 'admin_pusat', location: null },
            'gudang': { pass: 'gudang', name: 'Kepala Gudang', role: 'admin_gudang', location: 'Gudang' },
            'toko1': { pass: 'toko1', name: 'Kepala Toko 1', role: 'admin_toko', location: 'Toko Cabang 1' },
            'toko2': { pass: 'toko2', name: 'Kepala Toko 2', role: 'admin_toko', location: 'Toko Cabang 2' },
            'toko3': { pass: 'toko3', name: 'Kepala Toko 3', role: 'admin_toko', location: 'Toko Cabang 3' },
            'staff1': { pass: 'staff1', name: 'Staff Toko 1', role: 'staff', location: 'Toko Cabang 1' }
        };

        // State
        let users = JSON.parse(localStorage.getItem('ss_users')) || DEFAULT_USERS;
        let products = JSON.parse(localStorage.getItem('ss_products')) || [];
        let inventory = JSON.parse(localStorage.getItem('ss_inventory')) || []; 
        let transactions = JSON.parse(localStorage.getItem('ss_transactions')) || [];
        let requests = JSON.parse(localStorage.getItem('ss_requests')) || [];
        let returns = JSON.parse(localStorage.getItem('ss_returns')) || [];
        let masterData = JSON.parse(localStorage.getItem('ss_master')) || DEFAULT_MASTER;
        let auditLog = JSON.parse(localStorage.getItem('ss_audit')) || [];

        let currentLocationFilter = null; 
        let currentUser = null;
        let isOffline = !navigator.onLine;
        let opnameActive = {}; // Runtime flag { location: boolean }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Save Helper
        function saveData() {
            localStorage.setItem('ss_products', JSON.stringify(products));
            localStorage.setItem('ss_inventory', JSON.stringify(inventory));
            localStorage.setItem('ss_transactions', JSON.stringify(transactions));
            localStorage.setItem('ss_users', JSON.stringify(users));
            localStorage.setItem('ss_requests', JSON.stringify(requests));
            localStorage.setItem('ss_returns', JSON.stringify(returns));
            localStorage.setItem('ss_master', JSON.stringify(masterData));
            localStorage.setItem('ss_audit', JSON.stringify(auditLog));
        }

        function logActivity(action, details) {
            const log = {
                id: Date.now(),
                date: new Date().toISOString(),
                user: currentUser ? currentUser.username : 'system',
                role: currentUser ? currentUser.role : '-',
                action: action,
                details: details
            };
            auditLog.push(log);
            saveData();
        }

        // --- 2. CORE FUNCTIONS ---

        // Login Logic
        const SESSION_KEY = 'ss_session';
        function checkSession() {
            const sessionStr = localStorage.getItem(SESSION_KEY);
            if (sessionStr) {
                currentUser = JSON.parse(sessionStr);
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('userNameDisplay').textContent = currentUser.name;
                
                // Reset Role Items
                document.querySelectorAll('.nav-item-role').forEach(el => el.style.display = 'none');
                
                // Apply Restrictions
                if (currentUser.location) {
                    setGlobalLocation(currentUser.location);
                    document.getElementById('locationDropdown').classList.add('disabled');
                    document.getElementById('locationDropdown').style.pointerEvents = 'none';
                    // Hide Opname and Report Filters
                     document.getElementById('opnameLocation').disabled = true;
                     document.getElementById('reportLocationFilter').disabled = true;
                }
                
                // Role Logic
                const role = currentUser.role;
                // Mapping old 'admin' to 'admin_pusat' if needed, or handle in display
                
                if (role === 'admin_pusat' || role === 'admin') { // Handle legacy 'admin'
                    document.querySelectorAll('.nav-item-role').forEach(el => el.style.display = 'block'); // Show all
                    // Bottom nav duplicates, might want to be selective, but block is fine
                    document.querySelector('a[data-target="settings"]').parentElement.style.display = 'block';
                    document.getElementById('userManagementSection').style.display = 'block';
                    renderUserTable();
                } 
                else if (role === 'admin_gudang') {
                    document.querySelectorAll('.role-request').forEach(el => el.style.display = 'flex'); // Use flex for nav-link
                    document.querySelector('a[data-target="settings"]').parentElement.style.display = 'block';
                    document.getElementById('userManagementSection').style.display = 'none';
                }
                else if (role === 'admin_toko') {
                    document.querySelectorAll('.role-request').forEach(el => el.style.display = 'flex');
                    document.querySelector('a[data-target="settings"]').parentElement.style.display = 'none';
                }
                else {
                    // Staff
                    document.querySelector('a[data-target="settings"]').parentElement.style.display = 'none';
                }

                return true;
            }
            return false;
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const username = fd.get('username');
            const password = fd.get('password');
            
            const userConfig = users[username]; // Look up in dynamic users object

            if (userConfig && userConfig.pass === password) {
                const session = { 
                    username: username, 
                    name: userConfig.name, 
                    role: userConfig.role, 
                    location: userConfig.location,
                    loginTime: new Date() 
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(session));
                location.reload(); // Reload to apply permissions cleanly
            } else {
                document.getElementById('loginError').textContent = 'Username atau Password salah. (Coba: admin/admin, toko1/toko1)';
            }
        });

        function doLogout() {
            localStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        // Dark Mode Logic
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('ss_darkmode', isDark);
            
            // Toggle Icon
            const icon = isDark ? 'sun' : 'moon';
            document.getElementById('darkModeToggle').innerHTML = `<i data-feather="${icon}"></i>`;
            feather.replace();
        }

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        function initDarkMode() {
            const stored = localStorage.getItem('ss_darkmode');
            let isDark = false;

            if (stored !== null) {
                isDark = (stored === 'true');
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                isDark = true;
            }

            if (isDark) document.body.classList.add('dark-mode');
            document.getElementById('darkModeToggle').innerHTML = `<i data-feather="${isDark ? 'sun' : 'moon'}"></i>`;

            // Auto switch if no preference stored
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (localStorage.getItem('ss_darkmode') === null) {
                        if (e.matches) document.body.classList.add('dark-mode');
                        else document.body.classList.remove('dark-mode');
                        
                        const d = document.body.classList.contains('dark-mode');
                        document.getElementById('darkModeToggle').innerHTML = `<i data-feather="${d ? 'sun' : 'moon'}"></i>`;
                        feather.replace();
                    }
                });
            }
        }

        function updateOnlineStatus() {
            isOffline = !navigator.onLine;
            const banner = document.getElementById('offlineBanner');
            if (isOffline) {
                banner.style.display = 'block';
                document.body.classList.add('offline-mode');
            } else {
                banner.style.display = 'none';
                document.body.classList.remove('offline-mode');
            }
        }

        function initApp() {
            checkSession();
            initDarkMode();
            feather.replace();
            setupNavigation();
            populateLocationDropdowns();
            renderDashboard();
            renderProductTable();
            setupTransactionForms();
            setupSearchAutocomplete();
            
            // Set default date inputs to today
            document.querySelectorAll('input[type="date"]').forEach(inp => {
                inp.valueAsDate = new Date();
            });

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Error', err));
            }

            // Offline Listeners
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();

            // Request Persistent Storage
            if (navigator.storage && navigator.storage.persist) {
                navigator.storage.persist().then(granted => {
                    if (granted) {
                        console.log("Storage will not be cleared except by explicit user action");
                    } else {
                        console.log("Storage may be cleared by the UA under pressure.");
                    }
                });
            }
        }

        // Navigation Logic
        function setupNavigation() {
            // Sidebar Toggle
            document.getElementById('sidebarCollapse').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
                document.getElementById('content').classList.toggle('active');
            });

            // Navigation Links (Sidebar + Bottom Nav)
            const allNavLinks = document.querySelectorAll('.nav-link[data-target]');
            allNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const targetId = link.getAttribute('data-target');

                    // Active State Update (Sync both bars)
                    allNavLinks.forEach(l => {
                        if(l.getAttribute('data-target') === targetId) l.classList.add('active');
                        else l.classList.remove('active');
                    });

                    // Show Section
                    document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(targetId).classList.add('active');

                    // Refresh specific views if needed
                    if (targetId === 'dashboard') renderDashboard();
                    if (targetId === 'products') renderProductTable();
                    if (targetId === 'reports') refreshReport();

                    // Mobile close (Sidebar)
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('active');
                        document.getElementById('content').classList.remove('active');
                    }
                });
            });

            // Location Filter (Global)
            const locMenu = document.getElementById('locationSelectMenu');
            locMenu.innerHTML = `<li><a class="dropdown-item" href="#" onclick="setGlobalLocation(null)">Semua Lokasi</a></li>`;
            LOCATIONS.forEach(loc => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" onclick="setGlobalLocation('${loc}')">${loc}</a>`;
                locMenu.appendChild(li);
            });
        }

        function populateLocationDropdowns() {
            const selects = document.querySelectorAll('.select-location');
            selects.forEach(sel => {
                // Keep existing options if any (like "Semua Lokasi" in filters)
                const existing = sel.innerHTML;
                let opts = '';
                
                LOCATIONS.forEach(loc => {
                    // Filter logic: if user is restricted, only show their location
                    // BUT for Transfers "To" destination, we might want to allow others?
                    // For simplicity in this requirement "Akses Sendiri Sendiri", we lock it down mostly.
                    // Exception: Transfer TO location should allow others.
                    
                    if (currentUser && currentUser.location && currentUser.location !== loc) {
                        // If this select is NOT a 'to_location' in transfer, skip it
                        if (!sel.name || sel.name !== 'to_location') {
                            return; 
                        }
                    }
                    opts += `<option value="${loc}">${loc}</option>`;
                });
                sel.innerHTML = existing + opts;

                // Set value if single option
                if (currentUser && currentUser.location && (!sel.name || sel.name !== 'to_location')) {
                    sel.value = currentUser.location;
                }
            });
        }

        function setGlobalLocation(loc) {
            currentLocationFilter = loc;
            document.getElementById('currentLocationLabel').textContent = loc || 'Semua Lokasi';
            renderDashboard(); // Refresh dashboard with filter
            refreshReport();
        }

        // --- 3. DATA LOGIC ---

        function getStock(productId, location) {
            const item = inventory.find(i => i.productId == productId && i.location == location);
            return item ? item.qty : 0;
        }

        function getTotalStock(productId) {
            return inventory.filter(i => i.productId == productId).reduce((sum, item) => sum + item.qty, 0);
        }

        function updateStock(productId, location, change, type, notes = '', date = new Date().toISOString()) {
            // Opname Locking Check
            if (opnameActive[location] && type !== 'OPNAME_ADJ') {
                if (!currentUser || currentUser.role !== 'admin_pusat') {
                    alert(`Lokasi ${location} sedang dalam Opname. Transaksi diblokir.`);
                    return false;
                }
            }

            let item = inventory.find(i => i.productId == productId && i.location == location);
            if (!item) {
                item = { productId, location, qty: 0 };
                inventory.push(item);
            }
            
            // For OUT transactions, check availability
            if (change < 0 && (item.qty + change) < 0) {
                alert(`Stok tidak cukup di ${location}! Sisa: ${item.qty}`);
                return false;
            }

            item.qty += change;
            
            // Record Transaction
            transactions.push({
                id: Date.now(),
                date: date,
                productId,
                type, // 'IN', 'OUT', 'TRANSFER'
                location, // affected location (or From for transfer)
                qty: Math.abs(change),
                balance: item.qty,
                notes
            });

            saveData();
            
            // Real-time Update
            renderDashboard();
            renderProductTable();
            
            return true;
        }

        // --- 4. DASHBOARD ---
        
        let stockChartInstance = null;

        function renderDashboard() {
            // Metrics
            const totalItems = products.length;
            let totalQty = 0;
            let lowStockCount = 0;
            
            // Calculate totals based on Filter
            products.forEach(p => {
                let pQty = 0;
                if (currentLocationFilter) {
                    pQty = getStock(p.id, currentLocationFilter);
                } else {
                    pQty = getTotalStock(p.id);
                }
                totalQty += pQty;
                if (pQty < 5) lowStockCount++; // Warning threshold
            });

            // Today's Tx
            const todayStr = new Date().toISOString().split('T')[0];
            const todayTxOut = transactions.filter(t => t.type === 'OUT' && t.date.startsWith(todayStr) && (!currentLocationFilter || t.location === currentLocationFilter)).length;
            const todayTxIn = transactions.filter(t => t.type === 'IN' && t.date.startsWith(todayStr) && (!currentLocationFilter || t.location === currentLocationFilter)).length;
            const todayTx = todayTxOut + todayTxIn;

            document.getElementById('dash-total-items').textContent = totalItems;
            document.getElementById('dash-total-qty').textContent = totalQty;
            document.getElementById('dash-low-stock').textContent = lowStockCount;
            document.getElementById('dash-today-tx').textContent = todayTx;

            // Chart
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (stockChartInstance) stockChartInstance.destroy();
            
            // Dummy chart data logic for demo + Realtime Today
            stockChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['H-6', 'H-5', 'H-4', 'H-3', 'H-2', 'Kemarin', 'Hari Ini'],
                    datasets: [
                        {
                            label: 'Barang Masuk',
                            data: [5, 10, 5, 2, 8, 4, todayTxIn],
                            borderColor: '#dc3545', // RED
                            tension: 0.1
                        },
                        {
                            label: 'Barang Keluar',
                            data: [12, 19, 3, 5, 2, 3, todayTxOut], 
                            borderColor: '#0d6efd', // BLUE
                            tension: 0.1
                        }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Recent Activity
            const list = document.getElementById('recent-activity-list');
            list.innerHTML = '';
            const recentTx = transactions.slice().reverse().slice(0, 5);
            if (recentTx.length === 0) {
                 list.innerHTML = '<li class="list-group-item text-center text-muted py-4">Belum ada aktivitas</li>';
            } else {
                recentTx.forEach(tx => {
                    const prod = products.find(p => p.id == tx.productId);
                    const prodName = prod ? prod.name : 'Unknown';
                    const badge = tx.type === 'IN' ? 'bg-danger' : (tx.type === 'OUT' ? 'bg-primary' : 'bg-info');
                    list.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge ${badge} me-2">${tx.type}</span>
                                <small class="fw-bold">${prodName}</small>
                                <div class="text-muted small" style="font-size:0.8rem">${tx.location} - ${new Date(tx.date).toLocaleDateString()}</div>
                            </div>
                            <span class="fw-bold">${tx.qty}</span>
                        </li>
                    `;
                });
            }
        }

        // --- 5. PRODUCTS ---

        function renderProductTable() {
            const tbody = document.getElementById('productTableBody');
            const term = document.getElementById('productSearch').value.toLowerCase();
            tbody.innerHTML = '';

            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.code.toLowerCase().includes(term) ||
                p.category.toLowerCase().includes(term)
            );

            filtered.forEach(p => {
                const stock = getTotalStock(p.id);
                const img = p.image || 'https://via.placeholder.com/40';
                const min = p.min_stock || 5;
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${img}" width="40" height="40" class="rounded"></td>
                        <td>${p.code}</td>
                        <td>${p.name}</td>
                        <td>${p.category}</td>
                        <td>${p.color}, ${p.size}</td>
                        <td><span class="badge ${stock < min ? 'bg-danger' : 'bg-success'}">${stock}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditProduct(${p.id})"><i data-feather="edit-2"></i></button>
                        </td>
                    </tr>
                `;
            });
            feather.replace();
        }

        document.getElementById('productSearch').addEventListener('keyup', renderProductTable);

        document.getElementById('addProductForm').addEventListener('submit', (e) => {
            e.preventDefault();
            // Offline allowed
            const fd = new FormData(e.target);
            const newProd = {
                id: Date.now(),
                code: fd.get('code'),
                name: fd.get('name'),
                category: fd.get('category'),
                color: fd.get('color'),
                size: fd.get('size'),
                image: fd.get('image'),
                min_stock: parseInt(fd.get('min_stock')) || 5
            };
            products.push(newProd);
            saveData();
            logActivity('ADD_PRODUCT', `Added ${newProd.code}`);
            
            // Close modal & Refresh
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            e.target.reset();
            renderProductTable();
            alert('Barang berhasil ditambahkan');
        });

        // Edit Functionality
        let editingProductId = null;

        function openEditProduct(id) {
            if (isOffline) { alert('Aksi ini tidak tersedia saat offline.'); return; }
            const p = products.find(prod => prod.id == id);
            if (!p) return;
            editingProductId = id;

            const form = document.getElementById('editProductForm');
            form.querySelector('[name="id"]').value = p.id;
            form.querySelector('[name="code"]').value = p.code;
            form.querySelector('[name="name"]').value = p.name;
            form.querySelector('[name="category"]').value = p.category;
            form.querySelector('[name="color"]').value = p.color;
            form.querySelector('[name="size"]').value = p.size;
            form.querySelector('[name="image"]').value = p.image || '';
            form.querySelector('[name="min_stock"]').value = p.min_stock || 5;

            // RBAC for Master Data
            const canEditMaster = (!currentUser || currentUser.role === 'admin');
            const inputs = form.querySelectorAll('#edit-details input, #edit-details select');
            const warning = document.getElementById('edit-master-warning');
            
            if (canEditMaster) {
                inputs.forEach(i => i.disabled = false);
                warning.classList.add('d-none');
            } else {
                inputs.forEach(i => i.disabled = true);
                warning.classList.remove('d-none');
            }

            // Populate Stock Inputs
            const stockContainer = document.getElementById('edit-stock-inputs');
            stockContainer.innerHTML = '';
            
            LOCATIONS.forEach(loc => {
                // If user is restricted, only show their location
                if (currentUser && currentUser.location && currentUser.location !== loc) return;

                const qty = getStock(id, loc);
                stockContainer.innerHTML += `
                    <div class="row mb-2 align-items-center">
                        <div class="col-8">
                            <label class="form-label m-0">${loc}</label>
                        </div>
                        <div class="col-4">
                            <input type="number" class="form-control" name="stock_${loc}" value="${qty}" data-loc="${loc}" data-old="${qty}">
                        </div>
                    </div>
                `;
            });

            new bootstrap.Modal(document.getElementById('editProductModal')).show();
        }

        document.getElementById('editProductForm').addEventListener('submit', (e) => {
            e.preventDefault();
            // Offline allowed
            if (!editingProductId) return;

            const fd = new FormData(e.target);
            const pIndex = products.findIndex(p => p.id == editingProductId);
            
            if (pIndex > -1) {
                // 1. Save Master Data (if allowed)
                const canEditMaster = (!currentUser || currentUser.role === 'admin');
                if (canEditMaster) {
                    products[pIndex].code = fd.get('code');
                    products[pIndex].name = fd.get('name');
                    products[pIndex].category = fd.get('category');
                    products[pIndex].color = fd.get('color');
                    products[pIndex].size = fd.get('size');
                    products[pIndex].image = fd.get('image');
                    products[pIndex].min_stock = parseInt(fd.get('min_stock')) || 5;
                    logActivity('EDIT_PRODUCT', `Edited ${products[pIndex].code}`);
                }

                // 2. Save Stock Adjustments
                const stockInputs = document.querySelectorAll('#edit-stock-inputs input');
                let adjusted = false;
                stockInputs.forEach(input => {
                    const loc = input.getAttribute('data-loc');
                    const oldQty = parseInt(input.getAttribute('data-old'));
                    const newQty = parseInt(input.value);
                    
                    if (newQty !== oldQty) {
                        const diff = newQty - oldQty;
                        updateStock(editingProductId, loc, diff, 'MANUAL_EDIT', 'Koreksi Stok via Edit Menu');
                        adjusted = true;
                    }
                });

                saveData();
                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                renderProductTable();
                
                let msg = 'Data berhasil diperbarui.';
                if (adjusted) msg += ' Stok telah disesuaikan.';
                alert(msg);
            }
        });

        // --- 6. TRANSACTIONS & SEARCH ---

        function setupSearchAutocomplete() {
            document.querySelectorAll('.product-search-input').forEach(input => {
                const resultsContainer = input.parentElement.parentElement.querySelector('.product-search-results');
                const hiddenId = input.parentElement.parentElement.querySelector('input[name="product_id"]');
                const infoDiv = input.parentElement.parentElement.querySelector('.selected-product-info');
                const stockDiv = input.parentElement.parentElement.querySelector('.current-stock-display'); // Optional

                input.addEventListener('input', () => {
                    const term = input.value.toLowerCase();
                    if (term.length < 1) {
                        resultsContainer.style.display = 'none';
                        return;
                    }
                    
                    const matches = products.filter(p => p.name.toLowerCase().includes(term) || p.code.toLowerCase().includes(term));
                    resultsContainer.innerHTML = '';
                    
                    if (matches.length > 0) {
                        resultsContainer.style.display = 'block';
                        matches.forEach(p => {
                            const a = document.createElement('a');
                            a.className = 'list-group-item list-group-item-action cursor-pointer';
                            a.innerHTML = `<small class="fw-bold">${p.code}</small> - ${p.name} (${p.color}, ${p.size})`;
                            a.onclick = () => {
                                input.value = `${p.name} - ${p.code}`;
                                hiddenId.value = p.id;
                                resultsContainer.style.display = 'none';
                                infoDiv.textContent = `${p.name} (${p.category} - ${p.color}, ${p.size})`;
                                
                                // Show current stock if context allows
                                if (stockDiv) {
                                    // Find location context
                                    const form = input.closest('form');
                                    const locSelect = form.querySelector('.select-location');
                                    if (locSelect) {
                                        const qty = getStock(p.id, locSelect.value);
                                        stockDiv.textContent = `Stok Saat Ini di ${locSelect.value}: ${qty}`;
                                    }
                                }
                            };
                            resultsContainer.appendChild(a);
                        });
                    } else {
                        resultsContainer.style.display = 'none';
                    }
                });

                // Hide when clicking outside
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target)) resultsContainer.style.display = 'none';
                });
            });
        }

        function setupTransactionForms() {
            // STOCK IN
            document.getElementById('formStockIn').addEventListener('submit', (e) => {
                e.preventDefault();
                // Offline allowed
                const fd = new FormData(e.target);
                const success = updateStock(fd.get('product_id'), fd.get('location'), parseInt(fd.get('qty')), 'IN', fd.get('notes'), fd.get('date'));
                if (success) {
                    alert('Stok Masuk Berhasil');
                    e.target.reset();
                    document.querySelector('#formStockIn .selected-product-info').textContent = '';
                }
            });

            // STOCK OUT
            document.getElementById('formStockOut').addEventListener('submit', (e) => {
                e.preventDefault();
                // Offline allowed
                const fd = new FormData(e.target);
                const success = updateStock(fd.get('product_id'), fd.get('location'), -parseInt(fd.get('qty')), 'OUT', fd.get('reason'), fd.get('date'));
                if (success) {
                    alert('Stok Keluar Berhasil');
                    e.target.reset();
                    document.querySelector('#formStockOut .selected-product-info').textContent = '';
                     document.querySelector('#formStockOut .current-stock-display').textContent = '';
                }
            });

            // TRANSFER
             document.getElementById('formStockTransfer').addEventListener('submit', (e) => {
                e.preventDefault();
                // Offline allowed
                const fd = new FormData(e.target);
                const from = fd.get('from_location');
                const to = fd.get('to_location');
                const pid = fd.get('product_id');
                const qty = parseInt(fd.get('qty'));
                const date = fd.get('date');

                if (from === to) {
                    alert('Lokasi asal dan tujuan tidak boleh sama');
                    return;
                }

                // Step 1: Out from Source
                if (updateStock(pid, from, -qty, 'TRANSFER_OUT', `Transfer ke ${to}`, date)) {
                    // Step 2: In to Dest
                    updateStock(pid, to, qty, 'TRANSFER_IN', `Transfer dari ${from}`, date);
                    alert('Transfer Berhasil');
                    e.target.reset();
                     document.querySelector('#formStockTransfer .selected-product-info').textContent = '';
                }
            });
        }

        // --- 7. OPNAME ---
        
        function loadOpnameForm() {
            const loc = document.getElementById('opnameLocation').value;
            const date = document.getElementById('opnameDate').value;
            
            if (!date) { alert('Pilih tanggal'); return; }

            // Lock Location
            opnameActive[loc] = true;

            document.getElementById('opnameWorkArea').style.display = 'block';
            document.getElementById('opnameTargetLabel').textContent = `Lokasi: ${loc} | Tanggal: ${date} (LOCKED)`;

            const tbody = document.getElementById('opnameTableBody');
            tbody.innerHTML = '';

            // List all products
            products.forEach(p => {
                const sysQty = getStock(p.id, loc);
                tbody.innerHTML += `
                    <tr data-pid="${p.id}">
                        <td>
                            <div class="fw-bold">${p.name}</div>
                            <small class="text-muted">${p.code}</small>
                        </td>
                        <td><span class="badge bg-secondary sys-qty">${sysQty}</span></td>
                        <td>
                            <input type="number" class="form-control form-control-sm real-qty" value="${sysQty}" onchange="calcDiff(this, ${sysQty})">
                        </td>
                        <td class="diff-val fw-bold text-success">0</td>
                        <td><input type="text" class="form-control form-control-sm opname-note"></td>
                    </tr>
                `;
            });
        }

        function calcDiff(input, sys) {
            const real = parseInt(input.value) || 0;
            const diff = real - sys;
            const row = input.closest('tr');
            const diffEl = row.querySelector('.diff-val');
            diffEl.textContent = diff;
            diffEl.className = 'diff-val fw-bold ' + (diff === 0 ? 'text-success' : 'text-danger');
        }

        function saveOpname() {
            // Offline allowed
            const loc = document.getElementById('opnameLocation').value;
            const date = document.getElementById('opnameDate').value;
            const rows = document.querySelectorAll('#opnameTableBody tr');
            
            let adjustmentCount = 0;

            rows.forEach(row => {
                const pid = row.getAttribute('data-pid');
                const real = parseInt(row.querySelector('.real-qty').value);
                const sys = parseInt(row.querySelector('.sys-qty').textContent);
                const note = row.querySelector('.opname-note').value;
                const diff = real - sys;

                if (diff !== 0) {
                    // Adjust stock automatically to match real
                    updateStock(pid, loc, diff, 'OPNAME_ADJ', `Selisih Opname: ${note}`, date);
                    adjustmentCount++;
                }
            });

            opnameActive[loc] = false;
            alert(`Opname Selesai. ${adjustmentCount} barang disesuaikan. Lokasi Unlocked.`);
            document.getElementById('opnameWorkArea').style.display = 'none';
            document.getElementById('formOpname').reset();
            logActivity('OPNAME_FINISH', `Opname at ${loc} completed`);
        }

        // --- 8. REPORTS ---
        
        let currentReportType = 'stock';

        function switchReport(type) {
            currentReportType = type;
            document.querySelectorAll('.card-header-tabs .nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
            refreshReport();
        }

        function refreshReport() {
            const tbody = document.getElementById('reportTableBody');
            const thead = document.getElementById('reportTableHead');
            const locFilter = document.getElementById('reportLocationFilter').value;
            tbody.innerHTML = '';

            if (currentReportType === 'stock') {
                thead.innerHTML = `<tr><th>Kode</th><th>Barang</th><th>Lokasi</th><th>Stok</th><th>Nilai (Est)</th></tr>`;
                
                products.forEach(p => {
                    LOCATIONS.forEach(loc => {
                        if (locFilter && loc !== locFilter) return;
                        const qty = getStock(p.id, loc);
                        if (qty !== 0) { // Only show existing stock
                             tbody.innerHTML += `
                                <tr>
                                    <td>${p.code}</td>
                                    <td>${p.name}</td>
                                    <td>${loc}</td>
                                    <td>${qty}</td>
                                    <td>-</td>
                                </tr>
                            `;
                        }
                    });
                });
            } else if (currentReportType === 'mutations') {
                thead.innerHTML = `<tr><th>Tanggal</th><th>Tipe</th><th>Barang</th><th>Lokasi</th><th>Qty</th><th>Ket</th></tr>`;
                
                // Sort by date desc
                const sortedTx = transactions.slice().sort((a,b) => new Date(b.date) - new Date(a.date));
                
                sortedTx.forEach(tx => {
                    if (locFilter && tx.location !== locFilter) return;
                    const prod = products.find(p => p.id == tx.productId);
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(tx.date).toLocaleDateString()}</td>
                            <td>${tx.type}</td>
                            <td>${prod ? prod.name : 'Unknown'}</td>
                            <td>${tx.location}</td>
                            <td>${tx.qty}</td>
                            <td>${tx.notes || '-'}</td>
                        </tr>
                    `;
                });
            }
        }

        function exportReportToExcel() {
            const wb = XLSX.utils.book_new();
            const dateStr = new Date().toISOString().split('T')[0];

            if (currentReportType === 'stock') {
                // Per Location Sheets
                LOCATIONS.forEach(loc => {
                    // Check if user has access
                    if (currentUser && currentUser.location && currentUser.location !== loc) return;

                    let data = [['Kode', 'Nama Barang', 'Kategori', 'Stok', 'Status']];
                    
                    products.forEach(p => {
                        const qty = getStock(p.id, loc);
                        if (qty !== 0) {
                             data.push([
                                 p.code,
                                 p.name,
                                 p.category,
                                 qty,
                                 qty < 5 ? 'Reorder' : 'Aman'
                             ]);
                        }
                    });

                    if (data.length > 1) { // Only add sheet if there is data
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, loc.substring(0, 30)); // Sheet name max 31 chars
                    }
                });

            } else if (currentReportType === 'mutations') {
                // Per Location Sheets
                LOCATIONS.forEach(loc => {
                     // Check if user has access
                    if (currentUser && currentUser.location && currentUser.location !== loc) return;

                    let data = [['Tanggal', 'Tipe', 'Barang', 'Qty', 'Keterangan']];
                    
                    const locTx = transactions
                        .filter(t => t.location === loc)
                        .sort((a,b) => new Date(b.date) - new Date(a.date));

                    locTx.forEach(tx => {
                        const prod = products.find(p => p.id == tx.productId);
                        data.push([
                            new Date(tx.date).toLocaleDateString(),
                            tx.type,
                            prod ? prod.name : 'Unknown',
                            tx.qty,
                            tx.notes || '-'
                        ]);
                    });

                    if (data.length > 1) {
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, loc.substring(0, 30));
                    }
                });
            }

            XLSX.writeFile(wb, `Laporan_SmartStock_${currentReportType}_${dateStr}.xlsx`);
        }

        function resetApp() {
            if(confirm("Hapus semua data?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- 9. USER MANAGEMENT & SETTINGS ---

        function renderUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            
            Object.keys(users).forEach(username => {
                const u = users[username];
                tbody.innerHTML += `
                    <tr>
                        <td>${username}</td>
                        <td>${u.name}</td>
                        <td>${u.location || '<span class="text-muted">Semua (Admin)</span>'}</td>
                        <td>
                            ${username !== 'admin' ? 
                            `<button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${username}')"><i data-feather="trash-2"></i></button>` 
                            : ''}
                        </td>
                    </tr>
                `;
            });
            feather.replace();
        }

        function openAddUserModal() {
            if (isOffline) { alert('Aksi ini tidak tersedia saat offline.'); return; }
            document.getElementById('userForm').reset();
            document.getElementById('userFormTitle').textContent = 'Tambah User';
            toggleLocSelect();
            new bootstrap.Modal(document.getElementById('userFormModal')).show();
        }

        function toggleLocSelect() {
            const role = document.getElementById('userFormRole').value;
            const div = document.getElementById('userFormLocDiv');
            if (role === 'admin') {
                div.style.display = 'none';
            } else {
                div.style.display = 'block';
            }
        }

        document.getElementById('userForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (isOffline) { alert('Aksi ini tidak tersedia saat offline.'); return; }
            const fd = new FormData(e.target);
            const username = fd.get('username');
            
            if (users[username]) {
                alert('Username sudah ada!');
                return;
            }

            users[username] = {
                pass: fd.get('password'),
                name: fd.get('name'),
                role: fd.get('role'),
                location: fd.get('role') === 'admin' ? null : fd.get('location')
            };
            
            saveData();
            bootstrap.Modal.getInstance(document.getElementById('userFormModal')).hide();
            renderUserTable();
            alert('User berhasil ditambahkan');
        });

        function deleteUser(username) {
            if (isOffline) { alert('Aksi ini tidak tersedia saat offline.'); return; }
            if (confirm(`Hapus user ${username}?`)) {
                delete users[username];
                saveData();
                renderUserTable();
            }
        }

        function openProfileModal() {
            if (!currentUser) return;
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileRole').textContent = currentUser.role === 'admin' ? 'Administrator' : 'Staff / Kepala Cabang';
            document.getElementById('profileLocation').textContent = currentUser.location || 'Kantor Pusat';
            new bootstrap.Modal(document.getElementById('profileModal')).show();
        }

        // --- 10. BACKUP & RESTORE (EXCEL) ---

        function backupData() {
            // Security Check
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Akses Ditolak. Hanya admin yang dapat melakukan backup.');
                return;
            }

            if (isOffline) { alert('Fitur ini butuh memori browser, aman. Tapi sebaiknya online untuk sync.'); } // Just a warning or ignored
            
            const wb = XLSX.utils.book_new();
            
            // 1. Products
            if (products.length > 0) {
                const wsProd = XLSX.utils.json_to_sheet(products);
                XLSX.utils.book_append_sheet(wb, wsProd, "Products");
            }
            
            // 2. Inventory
            if (inventory.length > 0) {
                const wsInv = XLSX.utils.json_to_sheet(inventory);
                XLSX.utils.book_append_sheet(wb, wsInv, "Inventory");
            }
            
            // 3. Transactions
            if (transactions.length > 0) {
                const wsTx = XLSX.utils.json_to_sheet(transactions);
                XLSX.utils.book_append_sheet(wb, wsTx, "Transactions");
            }
            
            // 4. Users (Convert Object to Array for Sheet)
            const userArray = Object.keys(users).map(k => ({username: k, ...users[k]}));
            const wsUsers = XLSX.utils.json_to_sheet(userArray);
            XLSX.utils.book_append_sheet(wb, wsUsers, "Users");

            XLSX.writeFile(wb, `SmartStock_FullBackup_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function restoreData() {
            // Security Check
            if (currentUser.role !== 'admin_pusat' && currentUser.role !== 'admin') {
                alert('Akses Ditolak. Hanya admin pusat yang dapat melakukan restore.');
                return;
            }

            if (isOffline) { alert('Sebaiknya lakukan restore saat online.'); }

            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Pilih file backup (.xlsx) dulu');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    if (workbook.Sheets["Products"]) products = XLSX.utils.sheet_to_json(workbook.Sheets["Products"]);
                    if (workbook.Sheets["Inventory"]) inventory = XLSX.utils.sheet_to_json(workbook.Sheets["Inventory"]);
                    if (workbook.Sheets["Transactions"]) transactions = XLSX.utils.sheet_to_json(workbook.Sheets["Transactions"]);
                    if (workbook.Sheets["Requests"]) requests = XLSX.utils.sheet_to_json(workbook.Sheets["Requests"]);
                    if (workbook.Sheets["Returns"]) returns = XLSX.utils.sheet_to_json(workbook.Sheets["Returns"]);
                    if (workbook.Sheets["Master"]) {
                        const m = XLSX.utils.sheet_to_json(workbook.Sheets["Master"]);
                        if(m.length) masterData = m[0]; // Assuming single row object
                    }

                    if (workbook.Sheets["Users"]) {
                        const userArr = XLSX.utils.sheet_to_json(workbook.Sheets["Users"]);
                        users = {};
                        userArr.forEach(u => {
                            const uname = u.username;
                            delete u.username;
                            users[uname] = u;
                        });
                        if (Object.keys(users).length === 0) users = DEFAULT_USERS;
                    }

                    saveData();
                    alert('Restore berhasil! Aplikasi akan direload.');
                    location.reload();

                } catch (err) {
                    console.error(err);
                    alert('Gagal membaca file Excel.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- MASTER DATA FUNCTIONS ---
        function populateMasterDropdowns() {
            const forms = [document.getElementById('addProductForm'), document.getElementById('editProductForm')];
            forms.forEach(form => {
                if(!form) return;
                
                const cat = form.querySelector('.master-cat');
                const col = form.querySelector('.master-color');
                const siz = form.querySelector('.master-size');
                
                if(cat) cat.innerHTML = masterData.categories.map(c => `<option value="${c}">${c}</option>`).join('');
                if(col) col.innerHTML = masterData.colors.map(c => `<option value="${c}">${c}</option>`).join('');
                if(siz) siz.innerHTML = masterData.sizes.map(c => `<option value="${c}">${c}</option>`).join('');
            });
        }

        function renderMasterData() {
            ['categories', 'colors', 'sizes'].forEach(type => {
                const list = document.getElementById(`list-${type}`);
                if(!list) return;
                list.innerHTML = '';
                masterData[type].forEach((item, index) => {
                    list.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${item}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMaster('${type}', ${index})"><i data-feather="trash-2"></i></button>
                        </li>
                    `;
                });
            });
            feather.replace();
        }

        function addMaster(type) {
            let inputId = '';
            if(type === 'categories') inputId = 'newCatInput';
            if(type === 'colors') inputId = 'newColorInput';
            if(type === 'sizes') inputId = 'newSizeInput';
            
            const input = document.getElementById(inputId);
            const val = input.value.trim();
            if(val) {
                masterData[type].push(val);
                saveData();
                renderMasterData();
                populateMasterDropdowns();
                input.value = '';
                logActivity('ADD_MASTER', `Added ${val} to ${type}`);
            }
        }

        function deleteMaster(type, index) {
            if(confirm('Hapus data ini?')) {
                const val = masterData[type][index];
                masterData[type].splice(index, 1);
                saveData();
                renderMasterData();
                populateMasterDropdowns();
                logActivity('DELETE_MASTER', `Deleted ${val} from ${type}`);
            }
        }

        // --- REQUESTS & TRANSFER LOGIC ---
        function openRequestModal() {
            new bootstrap.Modal(document.getElementById('requestModal')).show();
        }

        document.getElementById('requestForm').addEventListener('submit', (e) => {
            e.preventDefault();
            // Offline allowed
            const fd = new FormData(e.target);
            const pid = fd.get('product_id');
            const p = products.find(i => i.id == pid);
            
            const req = {
                id: Date.now(),
                date: new Date().toISOString(),
                location: currentUser.location || 'Unknown', 
                items: [{ id: pid, name: p ? p.name : '?', qty: parseInt(fd.get('qty')) }],
                status: 'PENDING'
            };
            
            requests.push(req);
            saveData();
            logActivity('REQUEST_CREATE', `Request ${req.id}`);
            bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
            e.target.reset();
            renderRequests();
            alert('Request terkirim');
        });

        function renderRequests() {
            const tbody = document.getElementById('requestTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const role = currentUser ? currentUser.role : '';
            const myLoc = currentUser ? currentUser.location : '';
            
            const list = requests.filter(r => {
                if(role === 'admin_pusat' || role === 'admin_gudang') return true;
                if((role === 'admin_toko' || role === 'staff') && r.location === myLoc) return true;
                return false;
            }).sort((a,b) => b.id - a.id);

            list.forEach(r => {
                let badge = 'bg-secondary';
                if(r.status === 'APPROVED') badge = 'bg-info';
                if(r.status === 'REJECTED') badge = 'bg-danger';
                if(r.status === 'DELIVERED') badge = 'bg-success';
                
                let actions = '';
                if((role === 'admin_pusat' || role === 'admin_gudang') && r.status === 'PENDING') {
                    actions = `
                        <button class="btn btn-sm btn-success" onclick="processRequest(${r.id}, 'APPROVED')">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="processRequest(${r.id}, 'REJECTED')">Reject</button>
                    `;
                }
                if((role === 'admin_pusat' || role === 'admin_gudang') && r.status === 'APPROVED') {
                     actions = `<button class="btn btn-sm btn-primary" onclick="processRequest(${r.id}, 'DELIVERED')">Kirim Barang</button>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(r.date).toLocaleDateString()}</td>
                        <td>${r.location}</td>
                        <td>${r.items.map(i => `${i.name} (${i.qty})`).join(', ')}</td>
                        <td><span class="badge ${badge}">${r.status}</span></td>
                        <td>${actions}</td>
                    </tr>
                `;
            });
        }

        function processRequest(id, status) {
            const r = requests.find(x => x.id === id);
            if(!r) return;
            
            if(status === 'DELIVERED') {
                const item = r.items[0]; 
                if(updateStock(item.id, 'Gudang', -item.qty, 'TRANSFER_OUT', `Request ${r.id}`, new Date().toISOString())) {
                    const tx = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        productId: item.id,
                        type: 'TRANSFER_IN',
                        location: r.location,
                        qty: item.qty,
                        balance: 0,
                        notes: `Ref Request ${r.id}`,
                        status: 'IN_TRANSIT',
                        from_location: 'Gudang'
                    };
                    transactions.push(tx);
                    r.status = status;
                    saveData();
                    logActivity('REQ_PROCESS', `Request ${id} -> ${status}`);
                    renderRequests();
                    alert('Barang dikirim (In Transit)');
                }
            } else {
                r.status = status;
                saveData();
                logActivity('REQ_PROCESS', `Request ${id} -> ${status}`);
                renderRequests();
            }
        }

        function renderIncomingTransfers() {
            const tbody = document.getElementById('incomingTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const myLoc = currentUser ? currentUser.location : null;
            const list = transactions.filter(t => t.type === 'TRANSFER_IN' && t.status === 'IN_TRANSIT');
            
            list.forEach(t => {
                if(myLoc && t.location !== myLoc) return;
                
                const p = products.find(x => x.id == t.productId);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(t.date).toLocaleDateString()}</td>
                        <td>${t.from_location || '?'}</td>
                        <td>${p ? p.name : '?'}</td>
                        <td>${t.qty}</td>
                        <td><span class="badge bg-warning text-dark">In Transit</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="receiveTransfer(${t.id})">Terima</button>
                        </td>
                    </tr>
                `;
            });
        }

        function receiveTransfer(txId) {
            const tx = transactions.find(t => t.id === txId);
            if(!tx) return;
            
            // Manually update inventory to avoid double logging or complex status logic in updateStock
            let item = inventory.find(i => i.productId == tx.productId && i.location == tx.location);
            if (!item) {
                item = { productId: tx.productId, location: tx.location, qty: 0 };
                inventory.push(item);
            }
            item.qty += parseInt(tx.qty);
            
            tx.status = 'RECEIVED';
            saveData();
            renderIncomingTransfers();
            renderDashboard(); // Refresh stock counts
            logActivity('TRANSFER_RECV', `Tx ${txId} Received`);
            alert('Barang diterima. Stok bertambah.');
        }

        function renderAuditLog() {
            const tbody = document.getElementById('auditTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            auditLog.slice().reverse().slice(0, 50).forEach(l => {
                tbody.innerHTML += `<tr>
                    <td>${new Date(l.date).toLocaleString()}</td>
                    <td>${l.user}</td>
                    <td>${l.role}</td>
                    <td>${l.action}</td>
                    <td>${l.details}</td>
                </tr>`;
            });
        }

        // --- SCANNER LOGIC ---
        let html5QrcodeScanner = null;
        let currentScanTarget = null; 

        function startScanner(btnElement) {
            const inputGroup = btnElement.closest('.input-group');
            const input = inputGroup.querySelector('input[type="text"]');
            currentScanTarget = input;
            
            new bootstrap.Modal(document.getElementById('scannerModal')).show();
            
            setTimeout(() => {
                if(!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                }
                html5QrcodeScanner.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText, decodedResult) => {
                        console.log(`Scan: ${decodedText}`);
                        if(currentScanTarget) {
                            currentScanTarget.value = decodedText;
                            currentScanTarget.dispatchEvent(new Event('input'));
                        }
                        stopScanner();
                        bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide();
                    },
                    (errorMessage) => {}
                ).catch(err => {
                    console.error(err);
                    alert('Error accessing camera');
                });
            }, 500);
        }

        function stopScanner() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                }).catch(err => console.error(err));
            }
        }

        // --- RETURNS LOGIC ---
        function openReturnModal() {
            new bootstrap.Modal(document.getElementById('returnModal')).show();
        }

        document.getElementById('returnForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const pid = fd.get('product_id');
            const qty = parseInt(fd.get('qty'));
            const p = products.find(i => i.id == pid);
            const loc = currentUser.location;

            if(!loc) { alert('Hanya toko yang bisa retur'); return; }

            if(updateStock(pid, loc, -qty, 'RETURN_OUT', `Retur Pending`, new Date().toISOString())) {
                const ret = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    location: loc,
                    items: [{ id: pid, name: p ? p.name : '?', qty: qty }],
                    reason: fd.get('reason'),
                    status: 'PENDING'
                };
                
                returns.push(ret);
                saveData();
                logActivity('RETURN_CREATE', `Return ${ret.id}`);
                bootstrap.Modal.getInstance(document.getElementById('returnModal')).hide();
                e.target.reset();
                renderReturns();
                alert('Retur diajukan (Stok dikurangi)');
            }
        });

        function renderReturns() {
            const tbody = document.getElementById('returnTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const role = currentUser ? currentUser.role : '';
            const myLoc = currentUser ? currentUser.location : '';
            
            const list = returns.filter(r => {
                if(role === 'admin_pusat' || role === 'admin_gudang') return true;
                if((role === 'admin_toko' || role === 'staff') && r.location === myLoc) return true;
                return false;
            }).sort((a,b) => b.id - a.id);

            list.forEach(r => {
                let badge = 'bg-secondary';
                if(r.status === 'APPROVED') badge = 'bg-success';
                if(r.status === 'REJECTED') badge = 'bg-danger';
                
                let actions = '';
                if((role === 'admin_pusat' || role === 'admin_gudang') && r.status === 'PENDING') {
                    actions = `
                        <button class="btn btn-sm btn-success" onclick="processReturn(${r.id}, 'APPROVED')">Terima (Gudang)</button>
                        <button class="btn btn-sm btn-danger" onclick="processReturn(${r.id}, 'REJECTED')">Tolak</button>
                    `;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(r.date).toLocaleDateString()}</td>
                        <td>${escapeHtml(r.location)}</td>
                        <td>${r.items.map(i => `${escapeHtml(i.name)} (${i.qty})`).join(', ')}</td>
                        <td><span class="badge ${badge}">${r.status}</span></td>
                        <td>${actions}</td>
                    </tr>
                `;
            });
        }

        function processReturn(id, status) {
            const r = returns.find(x => x.id === id);
            if(!r) return;
            
            if(status === 'APPROVED') {
                const item = r.items[0]; 
                updateStock(item.id, 'Gudang', item.qty, 'RETURN_IN', `Ref Retur ${r.id} dari ${r.location}`, new Date().toISOString());
                r.status = 'APPROVED'; 
                saveData();
                logActivity('RET_PROCESS', `Return ${id} Approved`);
                renderReturns();
                alert('Retur Diterima (Stok Gudang Bertambah)');
            } else if (status === 'REJECTED') {
                const item = r.items[0];
                updateStock(item.id, r.location, item.qty, 'RETURN_REJECT_RESTORE', `Retur Ditolak`, new Date().toISOString());
                r.status = 'REJECTED';
                saveData();
                logActivity('RET_PROCESS', `Return ${id} Rejected`);
                renderReturns();
                alert('Retur Ditolak (Stok Toko Dikembalikan)');
            }
        }

        // START
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>